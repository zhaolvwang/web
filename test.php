<?php//phpinfo();//exit;set_time_limit(10000);include 'simple_html_dom.php';header("content-type:text/html;charset=utf-8;");$url = 'https://www.cnal.com/company_8I27Z3t/l0-v0-p1.shtml';//$url = 'https://www.cnal.com/company/';//$content = file_get_contents("compress.zlib://" . $url);$html = new simple_html_dom();//$html->load($content);$data = array();$error = '';$urlArrs = array();for($i=1; $i<= 10; $i++){    $url = 'https://www.cnal.com/company_8I27Z3t/l0-v0-p' . $i . '.shtml';    $content = get_url_page($url);    //从列表上获取【主营】内容    //$zhuyingArr = get_list_company_zhuying($content);    $html->load($content);    //$data[] = get_detail_url($html);    $urlArr = get_detail_url($html);    $urlArrs[] = $urlArr;//    foreach($urlArr as $key=>$uri){//        if(is_real_detail_url($uri)){//            //$tmp = parse_html($html);//            $tmp = parse_html(get_url_page($uri));//            $tmp['zhuying'] = $zhuyingArr[$key];//            $data[] = $tmp;//        }else{//            //file_put_contents();//            $num = $key+1;//            $error .= "第{$i}页，第{$num}条\n\r";//        }//////    }//    echo '第'.$i.'页采集完毕...<br>';    //print_r($data);    //file_put_contents('cnal_cartch_error.txt', $error);    //exit;}////联系方式//foreach($html->find('.w2product .text-con .place-company .w4 .ico-bond') as $dom){//    $tmp = array();//    //echo $dom . '----------->'. $dom->next_sibling ()->href;////    $page_content = get_url_page($dom->next_sibling()->href);////    $tmp = get_company_other($page_content);//    $tmp['name'] = get_company_name($page_content);//    //echo '<hr/>';//    //echo $name;//    $tmp['contacts'] = get_company_contacts($page_content);//    //echo '<hr/>';//    //echo $name;//    //echo '<hr/>';//    $data[] = $tmp;//    //unset($tmp);//    //print_r($tmp);//    //exit;//    //echo ;//    // exit;//}//$data = parse_html($html);print_r($urlArrs);file_put_contents('cnal_cartch_error.txt', $error);/** * 解析公司联系页 结构 * @param $html * @return array|mixed */function parse_html($page_content){    $tmp = get_company_other($page_content);    $tmp['name'] = get_company_name($page_content);    $tmp['contacts'] = get_company_contacts($page_content);    $data = $tmp;    return $data;}function get_detail_url($html){    foreach($html->find('.w2product .text-con .place-company .w4 .ico-bond') as $dom) {        $urls[] = trim($dom->next_sibling()->href);//        if(is_real_detail_url($dom->next_sibling()->href)){//            $urls[] = trim($dom->next_sibling()->href);//        }    }    return $urls;}/** * 判断是否为真实有效的联系页详情地址 * @param $url * @return bool */function is_real_detail_url($url){   return strpos($url, 'cnal.com/contact.shtml') !== false ? true : false;}/** * 获取压缩后的页面内容 * @param $url * @return string */function get_url_page($url){    return file_get_contents("compress.zlib://" . $url);}//========================begin 联系详情页采集 公共方法==========================/** * 获取公司名称 * @param $content * @return mixed */function get_company_name($content){    preg_match('/<div\s*class="tit_com">(.*)<\/div>/i', $content, $arr);    return trim($arr[1]);}/** * 获取公司联系人 * @param $content * @return mixed */function get_company_contacts($content){    preg_match('/<td>\s*<span\s*class="blue">(.*)<\/span>(?:.*)<\/td>/i', $content, $arr);    return trim($arr[1]);}/** * 抓取其他信息（结构一致） * @param $content * @return mixed */function get_company_other($content){    preg_match_all('/<tr>\s*<td\s*class="w140">(?:.*)<\/td>\s*<td>(.*)<\/td>\s*<\/tr>/iUs', $content, $arr);    $data = array();    $data['tel'] = $arr[1][1];    $data['phone'] = $arr[1][2];    $data['address'] = $arr[1][4];    $data['email'] = isset($arr[1][6]) ? $arr[1][6] : '';    return $data;}//==================end 联系详情页采集 公共方法======================================//===================列表页采集方法==================================================function get_list_company_name($html){    preg_match('/<div\s*class="zhuying">\s*<span\s*class="btn-tit">主营<\/span>(.*)<\/div>/i', $html, $arr);    print_r($arr);    return strip_tags($arr[1]);}function get_list_company_zhuying($html){    preg_match_all('/<div\s*class="zhuying">\s*<span\s*class="btn-tit">(?:.*)<\/span>(.*)<\/div>/iUs', $html, $arr);    //print_r($arr[1]);    //array_walk($arr[1],'strip_tags');    $arr[1] = array_map('clear_html',$arr[1]);    //echo '<hr/>';    //print_r($arr[1]);    //exit;//    foreach($arr[1] as &$value){//        $value = strip_tags($value);//    }    return $arr[1];//strip_tags($arr);}function clear_html($value){    $s = trim(str_replace(array("\n", "\r"), ' ', strip_tags($value)));    $s = str_replace('   ', ',', $s);    $s = str_replace('  ', ',', $s);    $s = str_replace(' ', ',', $s);    //$s = preg_replace('/\s*/', ' ', strip_tags($value));    return $s;}//===================end 列表页采集方法==============================================function get_url_content($url){    $ch=curl_init();    curl_setopt($ch,CURLOPT_URL,$url);    curl_setopt($ch,CURLOPT_SSL_VERIFYPEER,false);    curl_setopt($ch,CURLOPT_SSL_VERIFYHOST,false);    curl_setopt($ch,CURLOPT_RETURNTRANSFER,1);    $result=curl_exec($ch);    return $result;}//function getSslPage($url) {//    $ch = curl_init();//    $this_header = array(//        "charset=UTF-8"//    );//    curl_setopt($ch,CURLOPT_HTTPHEADER,$this_header);//    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);//    curl_setopt($ch, CURLOPT_HEADER, 0);//    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);//    curl_setopt($ch, CURLOPT_URL, $url);//    curl_setopt($ch, CURLOPT_REFERER, $url);//    curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);//    print_r(curl_error($ch));//    $result = curl_exec($ch);////    curl_close($ch);//    return $result;//}